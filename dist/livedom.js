!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).LiveDom=e()}(function(){return function r(o,i,a){function s(t,e){if(!i[t]){if(!o[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(c)return c(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}n=i[t]={exports:{}},o[t][0].call(n.exports,function(e){return s(o[t][1][e]||e)},n,n.exports,r,o,i,a)}return i[t].exports}for(var c="function"==typeof require&&require,e=0;e<a.length;e++)s(a[e]);return s}({1:[function(e,t,n){"use strict";function r(e){this.initData=e,this.pageData=Object.create(this.initData),this.scopeDataStack=[],this.data=Object.create(this.pageData)}Object.defineProperty(n,"__esModule",{value:!0}),n.DataManager=void 0,r.prototype.mergePageData=function(e){Object.assign(this.pageData,e)},r.prototype.pushScopeData=function(e){this.scopeDataStack.push(e),this.data=Object.create(this.data),Object.assign(this.data,e)},r.prototype.popScopeData=function(e){if(this.scopeDataStack[this.scopeDataStack.length-1]!=e)throw new Error("popScopeData fail! scopeData not last data.");this.scopeDataStack.pop(),this.data=Object.getPrototypeOf(this.data)},n.DataManager=r},{}],2:[function(e,t,n){"use strict";function r(e){this.controller=e}Object.defineProperty(n,"__esModule",{value:!0}),n.Directive=void 0,r.hasDirective=function(e){if(!e.directives||!Array.isArray(e.directives))return!1;for(var t=0,n=e.directives;t<n.length;t++)if(n[t]instanceof this)return!0;return!1},n.Directive=r},{}],3:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementEach=void 0,e("./Directive")),l=Symbol("LiveDomKeyDataProp"),e=(o=e.Directive,i(a,o),a.create=function(e,t,n,r){if(!n.attrs[r.attr])return null;var o=n.attrs[r.attr];return t.removeAttribute(r.attr),delete n.attrs[r.attr],new a(e,0,o)},a.prototype.render=function(e,o,i){var a=o.elementInfo,s=this.attrInfo.exec(this.controller.dataManager.data);if(!Array.isArray(s)||0==s.length)return[];for(var c=[],u=this,t=0,n=s.length;t<n;++t)!function(e){var t=s[e],n=t,r=o.exists.find(function(e){return l in e&&e[l]==n&&c.indexOf(e)<0})||u.controller.cloneNode(a.element),t=(r[l]=n,{item:t,index:e}),e=(u.controller.dataManager.pushScopeData(t),i(r,o));u.controller.dataManager.popScopeData(t),0<e.length&&c.push(e[0])}(t);return c},a);function a(e,t,n){e=o.call(this,e)||this;return e.attrInfo=n,e}n.DirectiveElementEach=e},{"./Directive":2}],4:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementElse=void 0,e("./Directive")),s=e("./DirectiveElementEach"),c=e("./DirectiveElementIf"),e=(o=a.Directive,i(u,o),u.create=function(e,t,n,r){return t.hasAttribute(r.attr)?(t.removeAttribute(r.attr),new u(e)):null},u.prototype.render=function(e,t,n){for(var r=t.exists[0];r=r.previousSibling;){if(this.controller.isPlaceholder(r)){var o=this.controller.getNodeInfo(r);if(c.DirectiveElementIf.hasDirective(o)||s.DirectiveElementEach.hasDirective(o))return n(e,t);break}if(1==r.nodeType)break}return[]},u);function u(e,t){return o.call(this,e)||this}n.DirectiveElementElse=e},{"./Directive":2,"./DirectiveElementEach":3,"./DirectiveElementIf":5}],5:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementIf=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.create=function(e,t,n,r){if(!n.attrs[r.attr])return null;var o=n.attrs[r.attr];return t.removeAttribute(r.attr),delete n.attrs[r.attr],new a(e,0,o)},a.prototype.render=function(e,t,n){t.elementInfo;return this.attrInfo.exec(this.controller.dataManager.data)?n(e,t):[]},a);function a(e,t,n){e=o.call(this,e)||this;return e.attrInfo=n,e}n.DirectiveElementIf=e},{"./Directive":2}],6:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementRender=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.create=function(e,t,n,r){return new a(e)},a.prototype.render=function(e,t,n){var r,o=t.elementInfo;for(r in o.attrs){var i=o.attrs[r].exec(this.controller.dataManager.data);e.setAttribute(r,i)}return this.controller.renderChildNodes(e),n(e,t)},a);function a(){return null!==o&&o.apply(this,arguments)||this}n.DirectiveElementRender=e},{"./Directive":2}],7:[function(e,t,n){"use strict";function r(e,t){this.ignoreElementTags={script:!0,style:!0},this.options=t,this.doc=e,this.observer=new MutationObserver(this.mutationObserverCallback.bind(this))}Object.defineProperty(n,"__esModule",{value:!0}),n.DomScanner=void 0,r.prototype.mutationObserverCallback=function(e){},n.DomScanner=r},{}],8:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DomScannerLoaded=void 0,e("./DomScanner")),e=(o=e.DomScanner,i(a,o),a.prototype.scan=function(){var n=this;return this.scanPromise||(this.scanPromise=new Promise(function(e,t){"complete"==n.doc.readyState?(n.walkNode(n.doc.documentElement),n.observer.observe(n.doc.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),e()):n.doc.addEventListener("DOMContentLoaded",function(){n.walkNode(n.doc.documentElement),n.observer.observe(n.doc.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),e()})}))},a.prototype.walkNode=function(e){switch(e.nodeType){case 1:this.processElement(e);break;case 3:this.processText(e);break;case 8:this.processComment(e)}},a.prototype.processElement=function(e){var t=this;this.ignoreElementTags[e.tagName.toLowerCase()]||(this.processElementStart(e),e.childNodes.forEach(function(e){t.walkNode(e)}),this.processElementEnd(e))},a.prototype.processElementStart=function(e){this.options.elementStart(e)},a.prototype.processElementEnd=function(e){this.options.elementEnd(e)},a.prototype.processComment=function(e){this.options.comment(e)},a.prototype.processText=function(e){this.options.text(e)},a);function a(){var e=null!==o&&o.apply(this,arguments)||this;return e.scanPromise=null,e}n.DomScannerLoaded=e},{"./DomScanner":7}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./Page"),o=e("./PageController");function i(){}i.initPage=function(e){void 0===e&&(e={});e=new o.PageController(document,e);return(0,r.createPage)(e)},n.default=i},{"./Page":10,"./PageController":11}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Page=n.createPage=void 0,n.createPage=function(e){var t=new r;return t.updateData=e.updatePageData.bind(e),t};var r=function(){};n.Page=r},{}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.PageController=void 0;var r=e("./DomScannerLoaded"),o=e("./DirectiveElementRender"),i=e("./DirectiveElementEach"),a=e("./DataManager"),s=e("./DirectiveElementIf"),c=e("./Parser"),u=e("./DirectiveElementElse"),l=Symbol("LiveDomInfoProp"),p=1001;function f(e,t){var n=this;this.scanCompletedPromise=null,this.requestRenderPagePromise=null,this.doc=e,this.options=t,this.dataManager=new a.DataManager(t.data||{}),this.elementDirectivesConfig=[{attr:"live:each",create:i.DirectiveElementEach.create},{attr:"live:if",create:s.DirectiveElementIf.create},{attr:"live:else",create:u.DirectiveElementElse.create},{attr:null,create:o.DirectiveElementRender.create}],this.scanner=new r.DomScannerLoaded(document,{elementStart:this.scanElementStart.bind(this),elementEnd:this.scanElementEnd.bind(this),comment:this.scanComment.bind(this),text:this.scanText.bind(this)}),this.scanCompletedPromise=this.scanner.scan().then(function(){n.options.loaded&&n.options.loaded(),n.requestRenderPage()})}function v(e){e.parentNode&&e.parentNode.removeChild(e)}function m(e,t){e!=t&&(e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t))}f.prototype.updatePageData=function(e){return this.dataManager.mergePageData(e=void 0===e?{}:e),this.requestRenderPage()},f.prototype.requestRenderPage=function(){var e=this;return this.requestRenderPagePromise||(this.requestRenderPagePromise=this.scanCompletedPromise.then(function(){e.requestRenderPagePromise=null,e.renderElement(e.doc.documentElement)}))},f.prototype.scanElementStart=function(e){this.setupElement(e)},f.prototype.scanElementEnd=function(e){},f.prototype.scanComment=function(e){},f.prototype.scanText=function(e){this.setupText(e)},f.prototype.setupElement=function(e){for(var t={id:"LDE"+p++,element:e,placeholderComment:null,attrs:{},directives:[]},n=e.attributes,r=n.length-1;0<=r;--r){var o=n[r],i=this.setupAttribute(o);i&&(t.attrs[o.name]=i)}this.setupElementDirectives(e,t),0==Object.keys(t.attrs).length&&0==Object.keys(t.directives).length?this.setNodeInfo(e,null):(t.render=this.renderElement.bind(this),this.setNodeInfo(e,t))},f.prototype.setupElementDirectives=function(e,t){for(var n=0,r=this.elementDirectivesConfig;n<r.length;n++){var o=r[n],o=o.create(this,e,t,o);o&&t.directives.push(o)}},f.prototype.setupAttribute=function(e){e=c.Parser.parseText(e.value);return c.Parser.hasTextExpress(e)?{exec:e.exec}:null},f.prototype.renderElement=function(e){var t=this.getNodeInfo(e);if(t){for(var n=[e],r=e.nextSibling;r;){if(this.getNodeInfo(r)!=t)break;n.push(r),r=r.nextSibling}var o=1==e.nodeType?e:t.element,i=this.processElementDirectiveRender(o,{elementInfo:t,exists:n},0);if(0==i.length){var a=this.getPlaceholderComment(t);m(e,a);for(var s=0,c=n;s<c.length;s++)(h=c[s])!=a&&v(h)}else{for(var u=e,l=0,p=i;l<p.length;l++)m(u,h=p[l]),u=h;for(var f=0,d=n;f<d.length;f++){var h=d[f];i.indexOf(h)<0&&v(h)}}}else this.renderChildNodes(e)},f.prototype.processElementDirectiveRender=function(e,t,n){var r=this,o=t.elementInfo.directives;return n<o.length?o[n].render(e,t,function(e,t){return r.processElementDirectiveRender(e,t,n+1)}):[e]},f.prototype.isPlaceholder=function(e){return 8==e.nodeType&&this.getNodeInfo(e).placeholderComment==e},f.prototype.getPlaceholderComment=function(e){return e.placeholderComment||(e.placeholderComment=this.doc.createComment("_LiveDomId="+e.id),this.setNodeInfo(e.placeholderComment,e),e.placeholderComment)},f.prototype.renderChildNodes=function(e){for(var t=p++,n=[],r=e.childNodes.length,o=0;o<r;++o)n.push(e.childNodes[o]);for(o=0;o<r;++o){var i=n[o],a=this.getNodeInfo(i);a?a._t!=t&&(a.render(i),a._t=t):1==i.nodeType&&this.renderChildNodes(i)}},f.prototype.setupText=function(e){var t,n=this,r=c.Parser.parseText(e.data);c.Parser.hasTextExpress(r)&&(t={id:"LDT"+p++,render:function(e){e.data=r.exec(n.dataManager.data)}},this.setNodeInfo(e,t))},f.prototype.cloneNode=function(e){var t=e.cloneNode(!0);return this.cloneNodesInfo([e],[t]),t},f.prototype.cloneNodesInfo=function(e,t){for(var n=0,r=e.length;n<r;++n)t[n][l]=e[n][l],1==e[n].nodeType&&this.cloneNodesInfo(e[n].childNodes,t[n].childNodes)},f.prototype.setNodeInfo=function(e,t){e[l]=t},f.prototype.getNodeInfo=function(e){return e[l]||null},f.prototype.hasNodeInfo=function(e){return!!e[l]},f.prototype.isLiveNode=function(e){return l in e},n.PageController=f},{"./DataManager":1,"./DirectiveElementEach":3,"./DirectiveElementElse":4,"./DirectiveElementIf":5,"./DirectiveElementRender":6,"./DomScannerLoaded":8,"./Parser":12}],12:[function(e,t,n){"use strict";function r(){}Object.defineProperty(n,"__esModule",{value:!0}),n.Parser=void 0,r.parseText=function(e){for(var t=/\$\{\s*([a-zA-z_]\w*(\.\w+)*)\s*\}/g,n=[],r=null,o=0;r=t.exec(e);){o<r.index&&n.push(e.substring(o,r.index));var i=r[1].split(/\./g);n.push(function(e){var t="",n=e.map(function(e){return(t=t+"."+e).substring(1)}),n="var ".concat(e[0],"=data.").concat(e[0],"; ")+"return (".concat(n.map(function(e){return"".concat(e,"!==null&&").concat(e,"!==void 0")}).join(" && "),") ? ").concat(e.join(".")," : null;");return new Function("data",n)}(i)),o=t.lastIndex}return o<e.length&&n.push(e.substring(o,e.length)),{parts:n,exec:function(i){if(1==i.length&&"function"==typeof i[0])return i[0];if(1!=i.length||"string"!=typeof i[0])return function(e){for(var t=[],n=0,r=i;n<r.length;n++){var o=r[n];"string"==typeof o?t.push(o):t.push(o(e))}return t.join("")};var e=i[0];return function(){return e}}(n)}},r.hasTextExpress=function(e){return 1<e.parts.length||1==e.parts.length&&"string"!=typeof e.parts[0]},n.Parser=r},{}],13:[function(e,t,n){"use strict";e=e("./LiveDom");t.exports=e.default},{"./LiveDom":9}]},{},[13])(13)});
//# sourceMappingURL=livedom.js.map
