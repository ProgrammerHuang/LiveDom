!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).LiveDom=e()}(function(){return function r(o,i,a){function s(t,e){if(!i[t]){if(!o[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(c)return c(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}n=i[t]={exports:{}},o[t][0].call(n.exports,function(e){return s(o[t][1][e]||e)},n,n.exports,r,o,i,a)}return i[t].exports}for(var c="function"==typeof require&&require,e=0;e<a.length;e++)s(a[e]);return s}({1:[function(e,t,n){"use strict";function r(e){this.topData={},this.scopeDataStack=[],this.lastMergeData={},this.pageData=Object.create(this.topData),this.data=Object.create(this.pageData),this.mergePageData(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.DataManager=void 0,r.prototype.mergePageData=function(e){Object.assign(this.lastMergeData,e),Object.assign(this.pageData,e)},r.prototype.commitMergeData=function(){this.lastMergeData={}},r.prototype.hasUseLastMergeData=function(e){for(var t in e)if(e[t][0]in this.lastMergeData)return!0;return!1},r.prototype.pushScopeData=function(e){this.scopeDataStack.push(e),this.data=Object.create(this.data),Object.assign(this.data,e)},r.prototype.popScopeData=function(e){if(this.scopeDataStack[this.scopeDataStack.length-1]!=e)throw new Error("popScopeData fail! scopeData not last data.");this.scopeDataStack.pop(),this.data=Object.getPrototypeOf(this.data)},n.DataManager=r},{}],2:[function(e,t,n){"use strict";function r(e){this.controller=e}Object.defineProperty(n,"__esModule",{value:!0}),n.Directive=void 0,r.hasDirective=function(e){if(!e.directives||!Array.isArray(e.directives))return!1;for(var t=0,n=e.directives;t<n.length;t++)if(n[t]instanceof this)return!0;return!1},n.Directive=r},{}],3:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementEach=void 0,e("./Directive")),p=Symbol("LiveDomKeyDataProp"),e=(o=e.Directive,i(a,o),a.setup=function(e,t,n,r){n.attrs[r.attr]&&(e=new a(e,0,n.attrs[r.attr]),t.removeAttribute(r.attr),n.attrs[r.attr].directive=e,t.hasAttribute("live:item")&&(e.itemName=t.getAttribute("live:item"),t.removeAttribute("live:item")),t.hasAttribute("live:index")&&(e.indexName=t.getAttribute("live:index"),t.removeAttribute("live:index")),n.directives.push(e))},a.prototype.render=function(e,i,a){var s=i.elementInfo,c=this.attrInfo.exec(this.controller.dataManager.data);if(!Array.isArray(c)||0==c.length)return[];for(var u=[],l=this,t=0,n=c.length;t<n;++t)!function(e){var t,n=c[e],r=n,o=i.exists.find(function(e){return p in e&&e[p]==r&&u.indexOf(e)<0})||l.controller.cloneNode(s.element),n=(o[p]=r,(t={})[l.itemName]=n,t[l.indexName]=e,t),e=(l.controller.dataManager.pushScopeData(n),a(o,i));l.controller.dataManager.popScopeData(n),0<e.length&&u.push(e[0])}(t);return u},a);function a(e,t,n){e=o.call(this,e)||this;return e.itemName="item",e.indexName="index",e.attrInfo=n,e}n.DirectiveElementEach=e},{"./Directive":2}],4:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementElse=void 0,e("./Directive")),s=e("./DirectiveElementEach"),c=e("./DirectiveElementIf"),e=(o=a.Directive,i(u,o),u.setup=function(e,t,n,r){t.hasAttribute(r.attr)&&(e=new u(e),t.removeAttribute(r.attr),n.attrs[r.attr]&&(n.attrs[r.attr].directive=e),n.directives.push(e))},u.prototype.render=function(e,t,n){for(var r=t.exists[0];r=r.previousSibling;){if(this.controller.isPlaceholder(r)){var o=this.controller.getNodeInfo(r);if(c.DirectiveElementIf.hasDirective(o)||s.DirectiveElementEach.hasDirective(o))return n(e,t);break}if(1==r.nodeType)break}return[]},u);function u(e,t){return o.call(this,e)||this}n.DirectiveElementElse=e},{"./Directive":2,"./DirectiveElementEach":3,"./DirectiveElementIf":5}],5:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementIf=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.setup=function(e,t,n,r){n.attrs[r.attr]&&(e=new a(e,0,n.attrs[r.attr]),t.removeAttribute(r.attr),n.attrs[r.attr].directive=e,n.directives.push(e))},a.prototype.render=function(e,t,n){t.elementInfo;return this.attrInfo.exec(this.controller.dataManager.data)?n(e,t):[]},a);function a(e,t,n){e=o.call(this,e)||this;return e.attrInfo=n,e}n.DirectiveElementIf=e},{"./Directive":2}],6:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementRender=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.setup=function(e,t,n,r){e=new a(e);n.directives.push(e)},a.prototype.render=function(e,t,n){var r,o=t.elementInfo;for(r in o.attrs){var i=o.attrs[r];i.directive||(i=i.exec(this.controller.dataManager.data),e.setAttribute(r,i))}return this.controller.renderChildNodes(e),n(e,t)},a);function a(){return null!==o&&o.apply(this,arguments)||this}n.DirectiveElementRender=e},{"./Directive":2}],7:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveHtmlInputRender=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.setup=function(e,t,n,r){if("input"!=t.tagName.toLocaleLowerCase())return null;var o={};t.hasAttribute("value")&&n.attrs.value&&(o.value=n.attrs.value,t.removeAttribute("value"),delete n.attrs.value),t.hasAttribute("checked")&&n.attrs.checked&&(o.checked=n.attrs.checked,t.removeAttribute("checked"),delete n.attrs.checked),0<Object.keys(o).length&&n.directives.push(new a(e,0,o))},a.prototype.render=function(e,t,n){var r;t.elementInfo;return this.attrs.value&&this.controller.dataManager.hasUseLastMergeData(this.attrs.value.paths)&&(r=this.attrs.value.exec(this.controller.dataManager.data),e.setAttribute("value",r),e.value=r),this.attrs.checked&&this.controller.dataManager.hasUseLastMergeData(this.attrs.checked.paths)&&(r=this.attrs.checked.exec(this.controller.dataManager.data),e.checked=!!r),n(e,t)},a);function a(e,t,n){e=o.call(this,e)||this;return e.attrs=n,e}n.DirectiveHtmlInputRender=e},{"./Directive":2}],8:[function(e,t,n){"use strict";function r(e,t){this.ignoreElementTags={script:!0,style:!0},this.options=t,this.doc=e,this.observer=new MutationObserver(this.mutationObserverCallback.bind(this))}Object.defineProperty(n,"__esModule",{value:!0}),n.DomScanner=void 0,r.prototype.startObserve=function(){this.observer.observe(this.doc.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0})},r.prototype.mutationObserverCallback=function(e){},n.DomScanner=r},{}],9:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(n,"__esModule",{value:!0}),n.DomScannerLoaded=void 0,e("./DomScanner")),e=(o=e.DomScanner,i(a,o),a.prototype.scan=function(){var n=this;return this.scanPromise||(this.scanPromise=new Promise(function(e,t){"complete"==n.doc.readyState?(n.walkNode(n.doc.documentElement),n.startObserve(),e()):n.doc.addEventListener("DOMContentLoaded",function(){n.walkNode(n.doc.documentElement),n.startObserve(),e()})}))},a.prototype.walkNode=function(e){switch(e.nodeType){case 1:this.processElement(e);break;case 3:this.processText(e);break;case 8:this.processComment(e)}},a.prototype.processElement=function(e){var t=this;this.ignoreElementTags[e.tagName.toLowerCase()]||(this.processElementStart(e),e.childNodes.forEach(function(e){t.walkNode(e)}),this.processElementEnd(e))},a.prototype.processElementStart=function(e){this.options.elementStart(e)},a.prototype.processElementEnd=function(e){this.options.elementEnd(e)},a.prototype.processComment=function(e){this.options.comment(e)},a.prototype.processText=function(e){this.options.text(e)},a);function a(){var e=null!==o&&o.apply(this,arguments)||this;return e.scanPromise=null,e}n.DomScannerLoaded=e},{"./DomScanner":8}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./Page"),o=e("./PageController");function i(){}i.initPage=function(e){void 0===e&&(e={});e=new o.PageController(document,e);return(0,r.createPage)(e)},n.default=i},{"./Page":11,"./PageController":12}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Page=n.createPage=void 0,n.createPage=function(e){var t=new r;return t.updateData=e.updatePageData.bind(e),t};var r=function(){};n.Page=r},{}],12:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.PageController=void 0;var r=e("./DomScannerLoaded"),i=e("./Parser"),o=e("./DataManager"),a=e("./DirectiveElementRender"),s=e("./DirectiveElementEach"),c=e("./DirectiveElementIf"),u=e("./DirectiveElementElse"),l=e("./DirectiveHtmlInputRender"),p=Symbol("LiveDomInfoProp"),d=1001;function f(e,t){var n=this;this.scanCompletedPromise=null,this.requestRenderPagePromise=null,this.doc=e,this.options=t,this.dataManager=new o.DataManager(this.options.data||{}),this.elementDirectivesConfig=[{attr:"live:each",setup:s.DirectiveElementEach.setup},{attr:"live:if",setup:c.DirectiveElementIf.setup},{attr:"live:else",setup:u.DirectiveElementElse.setup},{attr:null,setup:l.DirectiveHtmlInputRender.setup},{attr:null,setup:a.DirectiveElementRender.setup}],this.scanner=new r.DomScannerLoaded(document,{elementStart:this.scanElementStart.bind(this),elementEnd:this.scanElementEnd.bind(this),comment:this.scanComment.bind(this),text:this.scanText.bind(this),textChanged:this.onTextChanged.bind(this)}),this.scanCompletedPromise=this.scanner.scan().then(function(){n.options.onPageSetupCompleted&&n.options.onPageSetupCompleted(),n.requestRenderPage()})}function v(e){e.parentNode&&e.parentNode.removeChild(e)}function m(e,t){e!=t&&(e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t))}f.prototype.updatePageData=function(e){return this.dataManager.mergePageData(e=void 0===e?{}:e),this.requestRenderPage()},f.prototype.requestRenderPage=function(){var e=this;return this.requestRenderPagePromise||(this.requestRenderPagePromise=this.scanCompletedPromise.then(function(){return t=5,new Promise(function(e){setTimeout(e,t)});var t}).then(function(){e.requestRenderPagePromise=null,e.renderElement(e.doc.documentElement),e.dataManager.commitMergeData()}))},f.prototype.scanElementStart=function(e){this.setupElement(e)},f.prototype.scanElementEnd=function(e){},f.prototype.scanComment=function(e){},f.prototype.scanText=function(e){this.setupText(e)},f.prototype.onTextChanged=function(e){this.getNodeInfo(e)||this.setupText(e)},f.prototype.setupElement=function(e){var t=this.getNodeInfo(e)||{id:"LDE"+d++,element:e,placeholderComment:null,attrs:{},directives:[]};this.setElementAttributes(e,t),this.setupElementDirectives(e,t),0==Object.keys(t.attrs).length&&0==Object.keys(t.directives).length?this.setNodeInfo(e,null):(t.render=this.renderElement.bind(this),this.setNodeInfo(e,t))},f.prototype.setElementAttributes=function(e,t){for(var n=e.attributes,r=n.length-1;0<=r;--r){var o,i=n[r];t.attrs[i.name]&&t.attrs[i.name].srcVal==i.value||((o=this.setupAttribute(i))?t.attrs[i.name]=o:delete t.attrs[i.name])}},f.prototype.setupAttribute=function(e){var e=e.value,t=i.Parser.parseText(e);return i.Parser.hasTextExpress(t)?{srcVal:e,paths:t.paths,exec:t.exec,directive:null}:null},f.prototype.setupElementDirectives=function(e,t){for(var n=0,r=this.elementDirectivesConfig;n<r.length;n++){var o=r[n];o.setup(this,e,t,o)}},f.prototype.renderElement=function(e){var t=this.getNodeInfo(e);if(t){for(var n=[e],r=e.nextSibling;r;){if(this.getNodeInfo(r)!=t)break;n.push(r),r=r.nextSibling}var o=1==e.nodeType?e:t.element,i=this.processElementDirectiveRender(o,{elementInfo:t,exists:n},0);if(0==i.length){var a=this.getPlaceholderComment(t);m(e,a);for(var s=0,c=n;s<c.length;s++)(h=c[s])!=a&&v(h)}else{for(var u=e,l=0,p=i;l<p.length;l++)m(u,h=p[l]),u=h;for(var d=0,f=n;d<f.length;d++){var h=f[d];i.indexOf(h)<0&&v(h)}}}else this.renderChildNodes(e)},f.prototype.processElementDirectiveRender=function(e,t,n){var r=this,o=t.elementInfo.directives;return n<o.length?o[n].render(e,t,function(e,t){return r.processElementDirectiveRender(e,t,n+1)}):[e]},f.prototype.isPlaceholder=function(e){if(8!=e.nodeType)return!1;var t=this.getNodeInfo(e);return!!t&&t.placeholderComment==e},f.prototype.getPlaceholderComment=function(e){return e.placeholderComment||(e.placeholderComment=this.doc.createComment("_LiveDomId="+e.id),this.setNodeInfo(e.placeholderComment,e),e.placeholderComment)},f.prototype.renderChildNodes=function(e){for(var t=d++,n=[],r=e.childNodes.length,o=0;o<r;++o)n.push(e.childNodes[o]);for(o=0;o<r;++o){var i=n[o],a=this.getNodeInfo(i);a?a._t!=t&&(a.render(i),a._t=t):1==i.nodeType&&this.renderChildNodes(i)}},f.prototype.setupText=function(e){var t,n,r=this,o=i.Parser.parseText(e.data);i.Parser.hasTextExpress(o)&&(t={id:"LDT"+d++},n=o.exec,t.render=function(e){e.data=n(r.dataManager.data)},this.setNodeInfo(e,t))},f.prototype.cloneNode=function(e){var t=e.cloneNode(!0);return this.cloneNodesInfo([e],[t]),t},f.prototype.cloneNodesInfo=function(e,t){for(var n=0,r=e.length;n<r;++n)t[n][p]=e[n][p],1==e[n].nodeType&&this.cloneNodesInfo(e[n].childNodes,t[n].childNodes)},f.prototype.setNodeInfo=function(e,t){e[p]=t},f.prototype.getNodeInfo=function(e){return e[p]||null},f.prototype.hasNodeInfo=function(e){return!!e[p]},f.prototype.isLiveNode=function(e){return p in e},n.PageController=f},{"./DataManager":1,"./DirectiveElementEach":3,"./DirectiveElementElse":4,"./DirectiveElementIf":5,"./DirectiveElementRender":6,"./DirectiveHtmlInputRender":7,"./DomScannerLoaded":9,"./Parser":13}],13:[function(e,t,n){"use strict";function r(){}Object.defineProperty(n,"__esModule",{value:!0}),n.Parser=void 0,r.parseText=function(e){for(var t=/\$\{\s*([a-zA-z_]\w*(\.\w+)*)\s*\}/g,n=[],r={},o=null,i=0;o=t.exec(e);){i<o.index&&n.push(e.substring(i,o.index));var a=o[1].split(/\./g);r[o[1]]=a,n.push(function(e){var t="",n=e.map(function(e){return(t=t+"."+e).substring(1)}),n="var ".concat(e[0],"=data.").concat(e[0],"; ")+"return (".concat(n.map(function(e){return"".concat(e,"!==null&&").concat(e,"!==void 0")}).join(" && "),") ? ").concat(e.join(".")," : null;");return new Function("data",n)}(a)),i=t.lastIndex}return i<e.length&&n.push(e.substring(i,e.length)),{parts:n,paths:r,exec:function(i){if(1==i.length&&"function"==typeof i[0])return i[0];if(1!=i.length||"string"!=typeof i[0])return function(e){for(var t=[],n=0,r=i;n<r.length;n++){var o=r[n];"string"==typeof o?t.push(o):t.push(o(e))}return t.join("")};var e=i[0];return function(){return e}}(n)}},r.hasTextExpress=function(e){return 1<e.parts.length||1==e.parts.length&&"string"!=typeof e.parts[0]},n.Parser=r},{}],14:[function(e,t,n){"use strict";e=e("./LiveDom");t.exports=e.default},{"./LiveDom":10}]},{},[14])(14)});
//# sourceMappingURL=livedom.js.map
