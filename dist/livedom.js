!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).LiveDom=e()}(function(){return function n(o,i,a){function s(t,e){if(!i[t]){if(!o[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(c)return c(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}r=i[t]={exports:{}},o[t][0].call(r.exports,function(e){return s(o[t][1][e]||e)},r,r.exports,n,o,i,a)}return i[t].exports}for(var c="function"==typeof require&&require,e=0;e<a.length;e++)s(a[e]);return s}({1:[function(e,t,r){"use strict";function n(e){this.topData={},this.scopeDataStack=[],this.lastMergeData={},this.pageData=Object.create(this.topData),this.data=Object.create(this.pageData),this.mergePageData(e)}Object.defineProperty(r,"__esModule",{value:!0}),r.DataManager=void 0,n.prototype.mergePageData=function(e){Object.assign(this.lastMergeData,e),Object.assign(this.pageData,e)},n.prototype.commitMergeData=function(){this.lastMergeData={}},n.prototype.hasUseLastMergeData=function(e){for(var t in e)if(e[t][0]in this.lastMergeData)return!0;return!1},n.prototype.pushScopeData=function(e){this.scopeDataStack.push(e),this.data=Object.create(this.data),Object.assign(this.data,e)},n.prototype.popScopeData=function(e){if(this.scopeDataStack[this.scopeDataStack.length-1]!=e)throw new Error("popScopeData fail! scopeData not last data.");this.scopeDataStack.pop(),this.data=Object.getPrototypeOf(this.data)},r.DataManager=n},{}],2:[function(e,t,r){"use strict";function n(e){this.controller=e}Object.defineProperty(r,"__esModule",{value:!0}),r.Directive=void 0,n.hasDirective=function(e){if(!e.directives||!Array.isArray(e.directives))return!1;for(var t=0,r=e.directives;t<r.length;t++)if(r[t]instanceof this)return!0;return!1},r.Directive=n},{}],3:[function(e,t,r){"use strict";var n,o,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),e=(Object.defineProperty(r,"__esModule",{value:!0}),r.DirectiveElementEach=void 0,e("./Directive")),p=Symbol("LiveDomKeyDataProp"),e=(o=e.Directive,i(a,o),a.create=function(e,t,r,n){if(!r.attrs[n.attr])return null;var o=r.attrs[n.attr],r=(t.removeAttribute(n.attr),delete r.attrs[n.attr],new a(e,0,o));return t.hasAttribute("live:item")&&(r.itemName=t.getAttribute("live:item"),t.removeAttribute("live:item")),t.hasAttribute("live:index")&&(r.indexName=t.getAttribute("live:index"),t.removeAttribute("live:index")),r},a.prototype.render=function(e,i,a){var s=i.elementInfo,c=this.attrInfo.exec(this.controller.dataManager.data);if(!Array.isArray(c)||0==c.length)return[];for(var u=[],l=this,t=0,r=c.length;t<r;++t)!function(e){var t,r=c[e],n=r,o=i.exists.find(function(e){return p in e&&e[p]==n&&u.indexOf(e)<0})||l.controller.cloneNode(s.element),r=(o[p]=n,(t={})[l.itemName]=r,t[l.indexName]=e,t),e=(l.controller.dataManager.pushScopeData(r),a(o,i));l.controller.dataManager.popScopeData(r),0<e.length&&u.push(e[0])}(t);return u},a);function a(e,t,r){e=o.call(this,e)||this;return e.itemName="item",e.indexName="index",e.attrInfo=r,e}r.DirectiveElementEach=e},{"./Directive":2}],4:[function(e,t,r){"use strict";var n,o,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),a=(Object.defineProperty(r,"__esModule",{value:!0}),r.DirectiveElementElse=void 0,e("./Directive")),s=e("./DirectiveElementEach"),c=e("./DirectiveElementIf"),e=(o=a.Directive,i(u,o),u.create=function(e,t,r,n){return t.hasAttribute(n.attr)?(t.removeAttribute(n.attr),new u(e)):null},u.prototype.render=function(e,t,r){for(var n=t.exists[0];n=n.previousSibling;){if(this.controller.isPlaceholder(n)){var o=this.controller.getNodeInfo(n);if(c.DirectiveElementIf.hasDirective(o)||s.DirectiveElementEach.hasDirective(o))return r(e,t);break}if(1==n.nodeType)break}return[]},u);function u(e,t){return o.call(this,e)||this}r.DirectiveElementElse=e},{"./Directive":2,"./DirectiveElementEach":3,"./DirectiveElementIf":5}],5:[function(e,t,r){"use strict";var n,o,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),e=(Object.defineProperty(r,"__esModule",{value:!0}),r.DirectiveElementIf=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.create=function(e,t,r,n){if(!r.attrs[n.attr])return null;var o=r.attrs[n.attr];return t.removeAttribute(n.attr),delete r.attrs[n.attr],new a(e,0,o)},a.prototype.render=function(e,t,r){t.elementInfo;return this.attrInfo.exec(this.controller.dataManager.data)?r(e,t):[]},a);function a(e,t,r){e=o.call(this,e)||this;return e.attrInfo=r,e}r.DirectiveElementIf=e},{"./Directive":2}],6:[function(e,t,r){"use strict";var n,o,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),e=(Object.defineProperty(r,"__esModule",{value:!0}),r.DirectiveElementRender=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.create=function(e,t,r,n){return new a(e)},a.prototype.render=function(e,t,r){var n,o=t.elementInfo;for(n in o.attrs){var i=o.attrs[n].exec(this.controller.dataManager.data);e.setAttribute(n,i)}return this.controller.renderChildNodes(e),r(e,t)},a);function a(){return null!==o&&o.apply(this,arguments)||this}r.DirectiveElementRender=e},{"./Directive":2}],7:[function(e,t,r){"use strict";var n,o,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),e=(Object.defineProperty(r,"__esModule",{value:!0}),r.DirectiveHtmlInputRender=void 0,e("./Directive")),e=(o=e.Directive,i(a,o),a.create=function(e,t,r,n){if("input"!=t.tagName.toLocaleLowerCase())return null;var o={};return t.hasAttribute("value")&&r.attrs.value&&(o.value=r.attrs.value,t.removeAttribute("value"),delete r.attrs.value),t.hasAttribute("checked")&&r.attrs.checked&&(o.checked=r.attrs.checked,t.removeAttribute("checked"),delete r.attrs.checked),0<Object.keys(o).length?new a(e,0,o):null},a.prototype.render=function(e,t,r){var n;t.elementInfo;return this.attrs.value&&this.controller.dataManager.hasUseLastMergeData(this.attrs.value.paths)&&(n=this.attrs.value.exec(this.controller.dataManager.data),e.setAttribute("value",n),e.value=n),this.attrs.checked&&this.controller.dataManager.hasUseLastMergeData(this.attrs.checked.paths)&&(n=this.attrs.checked.exec(this.controller.dataManager.data),e.checked=!!n),r(e,t)},a);function a(e,t,r){e=o.call(this,e)||this;return e.attrs=r,e}r.DirectiveHtmlInputRender=e},{"./Directive":2}],8:[function(e,t,r){"use strict";function n(e,t){this.ignoreElementTags={script:!0,style:!0},this.options=t,this.doc=e,this.observer=new MutationObserver(this.mutationObserverCallback.bind(this))}Object.defineProperty(r,"__esModule",{value:!0}),r.DomScanner=void 0,n.prototype.mutationObserverCallback=function(e){},r.DomScanner=n},{}],9:[function(e,t,r){"use strict";var n,o,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),e=(Object.defineProperty(r,"__esModule",{value:!0}),r.DomScannerLoaded=void 0,e("./DomScanner")),e=(o=e.DomScanner,i(a,o),a.prototype.scan=function(){var r=this;return this.scanPromise||(this.scanPromise=new Promise(function(e,t){"complete"==r.doc.readyState?(r.walkNode(r.doc.documentElement),r.observer.observe(r.doc.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),e()):r.doc.addEventListener("DOMContentLoaded",function(){r.walkNode(r.doc.documentElement),r.observer.observe(r.doc.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),e()})}))},a.prototype.walkNode=function(e){switch(e.nodeType){case 1:this.processElement(e);break;case 3:this.processText(e);break;case 8:this.processComment(e)}},a.prototype.processElement=function(e){var t=this;this.ignoreElementTags[e.tagName.toLowerCase()]||(this.processElementStart(e),e.childNodes.forEach(function(e){t.walkNode(e)}),this.processElementEnd(e))},a.prototype.processElementStart=function(e){this.options.elementStart(e)},a.prototype.processElementEnd=function(e){this.options.elementEnd(e)},a.prototype.processComment=function(e){this.options.comment(e)},a.prototype.processText=function(e){this.options.text(e)},a);function a(){var e=null!==o&&o.apply(this,arguments)||this;return e.scanPromise=null,e}r.DomScannerLoaded=e},{"./DomScanner":8}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./Page"),o=e("./PageController");function i(){}i.initPage=function(e){void 0===e&&(e={});e=new o.PageController(document,e);return(0,n.createPage)(e)},r.default=i},{"./Page":11,"./PageController":12}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.Page=r.createPage=void 0,r.createPage=function(e){var t=new n;return t.updateData=e.updatePageData.bind(e),t};var n=function(){};r.Page=n},{}],12:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.PageController=void 0;var n=e("./DomScannerLoaded"),i=e("./Parser"),o=e("./DataManager"),a=e("./DirectiveElementRender"),s=e("./DirectiveElementEach"),c=e("./DirectiveElementIf"),u=e("./DirectiveElementElse"),l=e("./DirectiveHtmlInputRender"),p=Symbol("LiveDomInfoProp"),d=1001;function f(e,t){var r=this;this.scanCompletedPromise=null,this.requestRenderPagePromise=null,this.doc=e,this.options=t,this.dataManager=new o.DataManager(this.options.data||{}),this.elementDirectivesConfig=[{attr:"live:each",create:s.DirectiveElementEach.create},{attr:"live:if",create:c.DirectiveElementIf.create},{attr:"live:else",create:u.DirectiveElementElse.create},{attr:null,create:l.DirectiveHtmlInputRender.create},{attr:null,create:a.DirectiveElementRender.create}],this.scanner=new n.DomScannerLoaded(document,{elementStart:this.scanElementStart.bind(this),elementEnd:this.scanElementEnd.bind(this),comment:this.scanComment.bind(this),text:this.scanText.bind(this)}),this.scanCompletedPromise=this.scanner.scan().then(function(){r.options.onPageSetupCompleted&&r.options.onPageSetupCompleted(),r.requestRenderPage()})}function v(e){e.parentNode&&e.parentNode.removeChild(e)}function m(e,t){e!=t&&(e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t))}f.prototype.updatePageData=function(e){return this.dataManager.mergePageData(e=void 0===e?{}:e),this.requestRenderPage()},f.prototype.requestRenderPage=function(){var e=this;return this.requestRenderPagePromise||(this.requestRenderPagePromise=this.scanCompletedPromise.then(function(){return t=5,new Promise(function(e){setTimeout(e,t)});var t}).then(function(){e.requestRenderPagePromise=null,e.renderElement(e.doc.documentElement),e.dataManager.commitMergeData()}))},f.prototype.scanElementStart=function(e){this.setupElement(e)},f.prototype.scanElementEnd=function(e){},f.prototype.scanComment=function(e){},f.prototype.scanText=function(e){this.setupText(e)},f.prototype.setupElement=function(e){for(var t={id:"LDE"+d++,element:e,placeholderComment:null,attrs:{},directives:[]},r=e.attributes,n=r.length-1;0<=n;--n){var o=r[n],i=this.setupAttribute(o);i&&(t.attrs[o.name]=i)}this.setupElementDirectives(e,t),0==Object.keys(t.attrs).length&&0==Object.keys(t.directives).length?this.setNodeInfo(e,null):(t.render=this.renderElement.bind(this),this.setNodeInfo(e,t))},f.prototype.setupElementDirectives=function(e,t){for(var r=0,n=this.elementDirectivesConfig;r<n.length;r++){var o=n[r],o=o.create(this,e,t,o);o&&t.directives.push(o)}},f.prototype.setupAttribute=function(e){e=e.value,e=i.Parser.parseText(e);return i.Parser.hasTextExpress(e)?{paths:e.paths,exec:e.exec}:null},f.prototype.renderElement=function(e){var t=this.getNodeInfo(e);if(t){for(var r=[e],n=e.nextSibling;n;){if(this.getNodeInfo(n)!=t)break;r.push(n),n=n.nextSibling}var o=1==e.nodeType?e:t.element,i=this.processElementDirectiveRender(o,{elementInfo:t,exists:r},0);if(0==i.length){var a=this.getPlaceholderComment(t);m(e,a);for(var s=0,c=r;s<c.length;s++)(h=c[s])!=a&&v(h)}else{for(var u=e,l=0,p=i;l<p.length;l++)m(u,h=p[l]),u=h;for(var d=0,f=r;d<f.length;d++){var h=f[d];i.indexOf(h)<0&&v(h)}}}else this.renderChildNodes(e)},f.prototype.processElementDirectiveRender=function(e,t,r){var n=this,o=t.elementInfo.directives;return r<o.length?o[r].render(e,t,function(e,t){return n.processElementDirectiveRender(e,t,r+1)}):[e]},f.prototype.isPlaceholder=function(e){if(8!=e.nodeType)return!1;var t=this.getNodeInfo(e);return!!t&&t.placeholderComment==e},f.prototype.getPlaceholderComment=function(e){return e.placeholderComment||(e.placeholderComment=this.doc.createComment("_LiveDomId="+e.id),this.setNodeInfo(e.placeholderComment,e),e.placeholderComment)},f.prototype.renderChildNodes=function(e){for(var t=d++,r=[],n=e.childNodes.length,o=0;o<n;++o)r.push(e.childNodes[o]);for(o=0;o<n;++o){var i=r[o],a=this.getNodeInfo(i);a?a._t!=t&&(a.render(i),a._t=t):1==i.nodeType&&this.renderChildNodes(i)}},f.prototype.setupText=function(e){var t,r,n=this,o=i.Parser.parseText(e.data);i.Parser.hasTextExpress(o)&&(t={id:"LDT"+d++},r=o.exec,t.render=function(e){e.data=r(n.dataManager.data)},this.setNodeInfo(e,t))},f.prototype.cloneNode=function(e){var t=e.cloneNode(!0);return this.cloneNodesInfo([e],[t]),t},f.prototype.cloneNodesInfo=function(e,t){for(var r=0,n=e.length;r<n;++r)t[r][p]=e[r][p],1==e[r].nodeType&&this.cloneNodesInfo(e[r].childNodes,t[r].childNodes)},f.prototype.setNodeInfo=function(e,t){e[p]=t},f.prototype.getNodeInfo=function(e){return e[p]||null},f.prototype.hasNodeInfo=function(e){return!!e[p]},f.prototype.isLiveNode=function(e){return p in e},r.PageController=f},{"./DataManager":1,"./DirectiveElementEach":3,"./DirectiveElementElse":4,"./DirectiveElementIf":5,"./DirectiveElementRender":6,"./DirectiveHtmlInputRender":7,"./DomScannerLoaded":9,"./Parser":13}],13:[function(e,t,r){"use strict";function n(){}Object.defineProperty(r,"__esModule",{value:!0}),r.Parser=void 0,n.parseText=function(e){for(var t=/\$\{\s*([a-zA-z_]\w*(\.\w+)*)\s*\}/g,r=[],n={},o=null,i=0;o=t.exec(e);){i<o.index&&r.push(e.substring(i,o.index));var a=o[1].split(/\./g);n[o[1]]=a,r.push(function(e){var t="",r=e.map(function(e){return(t=t+"."+e).substring(1)}),r="var ".concat(e[0],"=data.").concat(e[0],"; ")+"return (".concat(r.map(function(e){return"".concat(e,"!==null&&").concat(e,"!==void 0")}).join(" && "),") ? ").concat(e.join(".")," : null;");return new Function("data",r)}(a)),i=t.lastIndex}return i<e.length&&r.push(e.substring(i,e.length)),{parts:r,paths:n,exec:function(i){if(1==i.length&&"function"==typeof i[0])return i[0];if(1!=i.length||"string"!=typeof i[0])return function(e){for(var t=[],r=0,n=i;r<n.length;r++){var o=n[r];"string"==typeof o?t.push(o):t.push(o(e))}return t.join("")};var e=i[0];return function(){return e}}(r)}},n.hasTextExpress=function(e){return 1<e.parts.length||1==e.parts.length&&"string"!=typeof e.parts[0]},r.Parser=n},{}],14:[function(e,t,r){"use strict";e=e("./LiveDom");t.exports=e.default},{"./LiveDom":10}]},{},[14])(14)});
//# sourceMappingURL=livedom.js.map
