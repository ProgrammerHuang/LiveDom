!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).LiveDom=e()}(function(){return function r(s,i,o){function a(t,e){if(!i[t]){if(!s[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(c)return c(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}n=i[t]={exports:{}},s[t][0].call(n.exports,function(e){return a(s[t][1][e]||e)},n,n.exports,r,s,i,o)}return i[t].exports}for(var c="function"==typeof require&&require,e=0;e<o.length;e++)a(o[e]);return a}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.DataManager=void 0;n.DataManager=class{constructor(e){this.initData=e,this.pageData=Object.create(this.initData),this.scopeDataStack=[],this.data=Object.create(this.pageData)}mergePageData(e){Object.assign(this.pageData,e)}pushScopeData(e){this.scopeDataStack.push(e),this.data=Object.create(this.data),Object.assign(this.data,e)}popScopeData(e){if(this.scopeDataStack[this.scopeDataStack.length-1]!=e)throw new Error("popScopeData fail! scopeData not last data.");this.scopeDataStack.pop(),this.data=Object.getPrototypeOf(this.data)}}},{}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Directive=void 0;n.Directive=class{constructor(e){this.controller=e}}},{}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementEach=void 0;e=e("./Directive");const h=Symbol("LiveDomKeyDataProp");class i extends e.Directive{constructor(e,t,n){super(e),this.attrInfo=n}static create(e,t,n,r){if(!n.attrs[r.attr])return null;var s=n.attrs[r.attr];return t.removeAttribute(r.attr),delete n.attrs[r.attr],new i(e,t,s)}render(e,t,n){var r=t.elementInfo,s=this.attrInfo.exec(this.controller.dataManager.data);let i=[];for(const c of s||[]){const l=c,d=t.exists.find(e=>h in e&&e[h]==l&&i.indexOf(e)<0)||this.controller.cloneNode(r.element);d[h]=l;var o={item:c},a=(this.controller.dataManager.pushScopeData(o),n(d,t));this.controller.dataManager.popScopeData(o),0<a.length&&i.push(a[0])}return i}}n.DirectiveElementEach=i},{"./Directive":2}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementIf=void 0;class i extends e("./Directive").Directive{constructor(e,t,n){super(e),this.attrInfo=n}static create(e,t,n,r){if(!n.attrs[r.attr])return null;var s=n.attrs[r.attr];return t.removeAttribute(r.attr),delete n.attrs[r.attr],new i(e,t,s)}render(e,t,n){t.elementInfo;return this.attrInfo.exec(this.controller.dataManager.data)?n(e,t):[]}}n.DirectiveElementIf=i},{"./Directive":2}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.DirectiveElementRender=void 0;class s extends e("./Directive").Directive{static create(e,t,n,r){return new s(e)}render(e,t,n){var r=t.elementInfo;for(const i in r.attrs){const o=r.attrs[i];var s=o.exec(this.controller.dataManager.data);e.setAttribute(i,s)}return this.controller.renderChildNodes(e),n(e,t)}}n.DirectiveElementRender=s},{"./Directive":2}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.DomScanner=void 0;n.DomScanner=class{constructor(e,t){this.ignoreElementTags={script:!0,style:!0},this.options=t,this.doc=e,this.observer=new MutationObserver(this.mutationObserverCallback.bind(this))}mutationObserverCallback(e){}}},{}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.DomScannerLoaded=void 0;class r extends e("./DomScanner").DomScanner{constructor(){super(...arguments),this.scanPromise=null}scan(){return this.scanPromise||(this.scanPromise=new Promise((e,t)=>{"complete"==this.doc.readyState?(this.walkNode(this.doc.documentElement),this.options.completed(),this.observer.observe(this.doc.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),e()):this.doc.addEventListener("DOMContentLoaded",()=>{this.walkNode(this.doc.documentElement),this.options.completed(),this.observer.observe(this.doc.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0}),e()})}))}walkNode(e){switch(e.nodeType){case 1:this.processElement(e);break;case 3:this.processText(e);break;case 8:this.processComment(e)}}processElement(e){this.ignoreElementTags[e.tagName.toLowerCase()]||(this.processElementStart(e),e.childNodes.forEach(e=>{this.walkNode(e)}),this.processElementEnd(e))}processElementStart(e){this.options.elementStart(e)}processElementEnd(e){this.options.elementEnd(e)}processComment(e){this.options.comment(e)}processText(e){this.options.text(e)}}n.DomScannerLoaded=r},{"./DomScanner":6}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const r=e("./PageController");n.default=class{static init(e={}){const t=new r.PageController(document,e);return t.parse().then(()=>t.page)}}},{"./PageController":10}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Page=void 0;n.Page=class{}},{}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.PageController=void 0;const r=e("./DomScannerLoaded"),s=e("./Page"),i=e("./DirectiveElementRender"),o=e("./DirectiveElementEach"),a=e("./DataManager"),c=e("./DirectiveElementIf"),l=e("./Parser"),d=Symbol("LiveDomInfoProp");let h=1001;function u(e){e.parentNode&&e.parentNode.removeChild(e)}function p(e,t){e!=t&&(e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t))}n.PageController=class{constructor(e,t){this.doc=e,this.options=t,this.dataManager=new a.DataManager(t.data||{}),this.elementDirectivesConfig=[{attr:"live:each",create:o.DirectiveElementEach.create},{attr:"live:if",create:c.DirectiveElementIf.create},{attr:null,create:i.DirectiveElementRender.create}],this.nodeInfos={},this.scanner=new r.DomScannerLoaded(document,{elementStart:this.scanElementStart.bind(this),elementEnd:this.scanElementEnd.bind(this),comment:this.scanComment.bind(this),text:this.scanText.bind(this),completed:this.scanCompleted.bind(this)}),this.scanner.scan(),this.initPage()}initPage(){this.page=new s.Page,this.page.updateData=this.updatePageData.bind(this)}updatePageData(e={}){return this.dataManager.mergePageData(e),this.renderElement(this.doc.documentElement),Promise.resolve()}parse(){return this.scanner.scan()}scanElementStart(e){this.setupElement(e)}scanElementEnd(e){}scanComment(e){}scanText(e){this.setupText(e)}scanCompleted(){this.renderElement(this.doc.documentElement)}setupElement(e){const t={id:"LDE"+h++,element:e,placeholderComment:null,attrs:{},directives:[],directiveAttrs:{}};var n=e.attributes;for(let e=n.length-1;0<=e;--e){var r=n[e],s=this.setupAttribute(r);s&&(t.attrs[r.name]=s)}this.setupElementDirectives(e,t),0==Object.keys(t.attrs).length&&0==Object.keys(t.directives).length&&0==Object.keys(t.directiveAttrs).length?this.setNodeInfo(e,null):(t.render=this.renderElement.bind(this),this.setNodeInfo(e,t))}setupElementDirectives(e,t){for(const r of this.elementDirectivesConfig){var n=r.create(this,e,t,r);n&&t.directives.push(n)}}setupAttribute(e){e=l.Parser.parseText(e.value);return l.Parser.hasTextExpress(e)?{exec:e.exec}:null}renderElement(t){var n=this.getNodeInfo(t);if(n){const o=[t];let e=t.nextSibling;for(;e;){if(this.getNodeInfo(e)!=n)break;o.push(e),e=e.nextSibling}var r={elementInfo:n,exists:o,renders:[],attrsVal:{},directivesVal:{}},s=1==t.nodeType?t:n.element;const a=this.processElementDirectiveRender(s,r,0);if(0==a.length){var i=this.getPlaceholderComment(n);p(t,i);for(const c of o)c!=i&&u(c)}else{let e=t;for(const l of a)p(e,l),e=l;for(const d of o)a.indexOf(d)<0&&u(d)}}else this.renderChildNodes(t)}processElementDirectiveRender(e,t,n){const r=t.elementInfo.directives;return n<r.length?r[n].render(e,t,(e,t)=>this.processElementDirectiveRender(e,t,n+1)):[e]}getPlaceholderComment(e){return e.placeholderComment||(e.placeholderComment=this.doc.createComment("_LiveDomId="+e.id),this.setNodeInfo(e.placeholderComment,e),e.placeholderComment)}renderChildNodes(t){var n=h++;const r=[];var s=t.childNodes.length;for(let e=0;e<s;++e)r.push(t.childNodes[e]);for(let e=0;e<s;++e){var i=r[e];const o=this.getNodeInfo(i);o?o._t!=n&&(o.render(i),o._t=n):1==i.nodeType&&this.renderChildNodes(i)}}setupText(e){const t=l.Parser.parseText(e.data);if(l.Parser.hasTextExpress(t)){const n={id:"LDT"+h++};n.render=e=>{e.data=t.exec(this.dataManager.data)},this.setNodeInfo(e,n)}}cloneNode(e){var t=e.cloneNode(!0);return this.cloneNodesInfo([e],[t]),t}cloneNodesInfo(n,r){for(let e=0,t=n.length;e<t;++e)r[e][d]=n[e][d],1==n[e].nodeType&&this.cloneNodesInfo(n[e].childNodes,r[e].childNodes)}setNodeInfo(e,t){e[d]=t}getNodeInfo(e){return e[d]||null}hasNodeInfo(e){return!!e[d]}isLiveNode(e){return d in e}}},{"./DataManager":1,"./DirectiveElementEach":3,"./DirectiveElementIf":4,"./DirectiveElementRender":5,"./DomScannerLoaded":7,"./Page":9,"./Parser":11}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Parser=void 0;n.Parser=class{static parseText(e){const t=/\$\{\s*([a-zA-z_]\w*(\.\w+)*)\s*\}/g,n=[];let r=null,s=0;for(;r=t.exec(e);){s<r.index&&n.push(e.substring(s,r.index));var i=r[1].split(/\./g);n.push(function(e){let t="",n=e.map(e=>(t=t+"."+e).substring(1)),r=`var ${e[0]}=data.${e[0]}; `+`return (${n.map(e=>e+`!==null&&${e}!==void 0`).join(" && ")}) ? ${e.join(".")} : null;`;return new Function("data",r)}(i)),s=t.lastIndex}return s<e.length&&n.push(e.substring(s,e.length)),{parts:n,exec:function(r){if(1==r.length&&"function"==typeof r[0])return r[0];if(1!=r.length||"string"!=typeof r[0])return function(e){const t=[];for(const n of r)"string"==typeof n?t.push(n):t.push(n(e));return t.join("")};{const e=r[0];return function(){return e}}}(n)}}static hasTextExpress(e){return 1<e.parts.length||1==e.parts.length&&"string"!=typeof e.parts[0]}}},{}],12:[function(e,t,n){"use strict";e=e("./LiveDom");t.exports=e.default},{"./LiveDom":8}]},{},[12])(12)});
//# sourceMappingURL=livedom.js.map
